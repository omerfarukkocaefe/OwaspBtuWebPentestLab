<?php

session_start();

if (isset($_SESSION["user2"])) {
   header("Location: panel_zafiyetsiz.php");
}

require_once "../database/db.php";

if (isset($_POST["login_button"])) {
    $username = $_POST["username_login"];
    $password = $_POST["password_login"];

    $sql = "SELECT * FROM users WHERE username = ?";
    $stmt = mysqli_prepare($conn, $sql);
    mysqli_stmt_bind_param($stmt, "s", $username);
    mysqli_stmt_execute($stmt);
    $result = mysqli_stmt_get_result($stmt);

    if ($result && mysqli_num_rows($result) > 0) {
        $user2 = mysqli_fetch_assoc($result);
        if (password_verify($password, $user2["password"])) {
            $_SESSION["user2"] = "yes";
            header("Location: panel_zafiyetsiz.php");
            exit();
        } else {
           
        }
    } else {
   
    }
}


?> 

<?php

        if (isset($_POST["register_button"])) {
            $fullName = mysqli_real_escape_string($conn, trim($_POST["username_register"])); // Sanitize username input
            $password = mysqli_real_escape_string($conn, trim($_POST["password_register"])); // Sanitize password input
        
            $errors = array();
        
            if (empty($fullName) || empty($password)) {
                array_push($errors, "All fields are required");
            }
        
        
            require_once "../database/db.php";
        
            $sql = "SELECT * FROM users WHERE username = ?"; // Prepared statement for username check
            $stmt = mysqli_stmt_init($conn);
        
            if (!mysqli_stmt_prepare($stmt, $sql)) {
                echo "SQL Error: " . mysqli_error($conn);
                die();
            }
        
            mysqli_stmt_bind_param($stmt, "s", $fullName); // Bind username to prepared statement
        
            if (!mysqli_stmt_execute($stmt)) {
                echo "Username check failed: " . mysqli_error($conn);
                die();
            }
        
            $result = mysqli_stmt_get_result($stmt);
            if (!$result) {
                echo "Username check failed (result error): " . mysqli_error($conn);
                die();
            }
        
            $rowCount = mysqli_num_rows($result);
            mysqli_stmt_close($stmt); // Close prepared statement
        
            if ($rowCount > 0) {
                array_push($errors, "Username already exists!");
            }
        
            if (count($errors) > 0) {
                foreach ($errors as $error) {
                    echo "<div class='alert alert-danger'>$error</div>";
                }
            } else {
                $passwordHash = password_hash($password, PASSWORD_DEFAULT); // Hash password securely
        
                $sql = "INSERT INTO users (username, password) VALUES (?, ?)"; // Prepared statement for registration
                $stmt = mysqli_stmt_init($conn);
        
                if (!mysqli_stmt_prepare($stmt, $sql)) {
                    echo "SQL Error: " . mysqli_error($conn);
                    die();
                }
        
                mysqli_stmt_bind_param($stmt, "ss", $fullName, $passwordHash); // Bind username and hashed password
        
                if (!mysqli_stmt_execute($stmt)) {
                    echo "Registration failed: " . mysqli_error($conn);
                    die();
                }
        
                mysqli_stmt_close($stmt); // Close prepared statement
        
                //echo "<script>alert('You are registered successfully.');</script>";
            }
        }
        ?>

        
<!DOCTYPE html>
<html>

<head>
    <meta charset=utf-8 />
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />
    <title> HTML5 lessons </title>
    <link rel="stylesheet" type="text/css" href="../Styles/style.css" />
    <link rel="stylesheet" type="text/css" href="../Styles/sqli/login.css" />
    <link rel="stylesheet" href="../Styles/bootstrap.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
</head>

<body>
    <script src="../Js/bootstrap.js"></script>
    <main>
       
        <?php require("../header/header1.php") ?>
        
        
        
        <div class="col mt-2 mb-2">
            <div class="d-flex flex-column-reverse align-items-center">
                    <div class="mainText px-2">

    <h1>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    SQL Injection Lab 
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </h1>
    
    <h1>
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    (Non-Vulnerable)
    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
    </h1>
    
    <div class="container">
        <div class="sign-in">
            <h2>Sign In</h2>
            <form action="login_zafiyetsiz.php" method="post">
                <input type="text" placeholder="Username" name="username_login" class="form-control" required> 
                <input type="password" placeholder="Password" name="password_login" class="form-control" required>
                <button type="submit" name="login_button">Sign In</button>
            </form>
        </div>
        <div class="sign-up">
            <h2>Sign Up</h2>
            <form action="login_zafiyetsiz.php" method="POST">
                <input type="text" placeholder="Username" name="username_register" required>
                <input type="password" placeholder="Password" name="password_register" required>
                <button type="submit" name="register_button">Sign Up</button>
            </form>
        </div> 
    </div>

                    </div>
            </div>                  
                        
        </div>

      
        <footer class="page-bottom" style="position:'relative'">

        <button class="primary" onclick="window.dialog.showModal();">Show Hint</button>

        <dialog id="dialog" class="dialog">
            <h2>Walkthrough</h2>
            <h4>Steps</h4>
            <li>Lorem ipsum dolor sit amet, consectetur adipiscing elit. Vivamus efficitur faucibus nisi. Mauris quis velit a eros dignissim accumsan. Fusce auctor ex est, sed ultricies urna feugiat vitae. Sed magna risus, facilisis ac turpis in, semper pharetra neque. Nam a ante accumsan nisl vehicula feugiat. Nam nisi neque, mattis eu tellus quis, facilisis porttitor metus. Quisque tempus tempor massa, vitae tincidunt elit tristique ac. Donec molestie sapien et quam mollis, vel gravida massa laoreet. Aliquam at felis volutpat, auctor tellus a, dignissim mauris. Sed convallis eros sit amet lorem auctor, id tincidunt nulla auctor</li>
            <li>123</li>
            <li>123</li>
            <p><a href="#">Tutorial Video</a></p>
            <button onclick="window.dialog.close();" aria-label="close" class="x">‚ùå</button>
        </dialog>

       <!--     
         <div class="d-flex flex-row gap-2">
         <div class="btn-group">
         <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" data-bs-auto-close="false" aria-expanded="false">
             Zafiyet Durumu
         </button>

         <ul class="dropdown-menu">
             <li><a class="dropdown-item" href="login_zafiyetsiz.php">Zafiyetsiz</a></li>
             <li><a class="dropdown-item" href="login_zafiyetli.php">Zafiyetli</a></li>
         </ul>
        
        </div>

             <div class="square">SQLi</br>(Zafiyetsiz)</div>
        </div>
        -->
        </footer>
        

    </main>

   

</body>

</html>


